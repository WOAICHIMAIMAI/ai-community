# 布隆过滤器监控和告警 API 文档

## 监控实现机制

### 1. 使用率计算
```java
// 实时计算使用率
double usageRatio = (double) loadedUrlCount / expectedInsertions;
```

### 2. 告警级别定义（7天数据周期优化）
| 级别 | 使用率范围 | 状态 | 描述 |
|------|------------|------|------|
| NORMAL | < 50% | ✅ 正常 | 使用率正常 |
| INFO | 50% - 70% | ℹ️ 注意 | 使用率较高，需要关注 |
| WARNING | 70% - 90% | ⚠️ 警告 | 使用率过高，建议准备重建 |
| CRITICAL | ≥ 90% | 🚨 危险 | 使用率极高，需要立即处理 |

### 3. 自动监控任务（7天周期优化）
- **执行频率**: 每15分钟检查一次（7天周期需要更频繁监控）
- **监控内容**: 使用率、告警级别、数据增长趋势
- **告警触发**: 当级别变化或达到WARNING/CRITICAL时
- **数据特点**: 每日约3000条新增，7天约21000条，容量50000

## API 接口

### 1. 获取统计信息
```http
GET /admin/news/bloom-filter/stats
```

**响应示例**:
```json
{
  "code": 200,
  "message": "success",
  "data": {
    "expectedInsertions": 200000,
    "falsePositiveProbability": 0.01,
    "loadedUrlCount": 85000,
    "usageRatio": 0.425,
    "lastRebuildTime": "2025-07-22T02:00:00",
    "dataRetentionDays": 60,
    "alertLevel": {
      "level": 0,
      "name": "正常",
      "description": "使用率正常"
    },
    "alertRecommendation": "使用率为 42.5%，无需特殊操作",
    "needsAttention": false
  }
}
```

### 2. 手动状态检查
```http
GET /admin/news/bloom-filter/check
```

**功能**: 立即检查状态并记录详细日志

### 3. 获取告警建议
```http
GET /admin/news/bloom-filter/alert-recommendation
```

**响应示例**:
```json
{
  "code": 200,
  "data": {
    "alertLevel": "警告",
    "alertDescription": "使用率过高，建议扩容或清理",
    "recommendation": "使用率已达到 85.0%，建议：\n1. 监控数据增长趋势\n2. 考虑调整数据保留策略\n3. 准备扩容方案",
    "needsImmediateAction": true,
    "usageRatio": 0.85
  }
}
```

### 4. 手动重建
```http
POST /admin/news/bloom-filter/rebuild
```

### 5. 监控配置信息
```http
GET /admin/news/bloom-filter/monitor-config
```

## 日志告警示例

### 正常状态
```
2025-07-22 10:30:00 DEBUG - ✅ 布隆过滤器使用率正常: 42.5%
```

### 注意状态
```
2025-07-22 10:30:00 INFO  - ℹ️ 布隆过滤器使用率注意: 65.0% - 使用率较高，需要关注
```

### 警告状态
```
2025-07-22 10:30:00 WARN  - ⚠️ 布隆过滤器使用率警告: 85.0% - 使用率过高，建议扩容或清理
2025-07-22 10:30:00 WARN  - 📈 布隆过滤器告警级别升级: 注意 -> 警告 (使用率: 85.0%)
```

### 危险状态
```
2025-07-22 10:30:00 ERROR - 🚨 布隆过滤器使用率危险: 96.0% - 使用率极高，需要立即处理
2025-07-22 10:30:00 ERROR - 🚨 布隆过滤器进入危险状态！
2025-07-22 10:30:00 ERROR -    使用率: 96.0%
2025-07-22 10:30:00 ERROR -    建议: 使用率已达到 96.0%，请立即执行以下操作之一：
                                1. 手动重建布隆过滤器
                                2. 减少数据保留天数
                                3. 增加预期容量配置
```

## 配置参数

```yaml
bloom-filter:
  monitoring:
    # 是否启用监控
    enabled: true
    # 检查间隔（分钟）
    check-interval-minutes: 30
    # 是否启用邮件告警
    email-alert-enabled: false
```

## 自动处理机制

### 1. 告警级别变化时
- 记录级别变化日志
- 发送详细状态信息
- 根据级别执行相应操作

### 2. 危险状态处理
```java
// 当使用率超过98%时，考虑自动重建
if (stats.getUsageRatio() > 0.98) {
    log.warn("使用率过高，考虑自动重建布隆过滤器");
    // 可选：自动触发重建（需谨慎）
}
```

### 3. 邮件告警（可选）
- 支持配置邮件告警
- 包含详细的状态信息和建议操作
- 只在WARNING和CRITICAL级别发送

## 监控最佳实践

### 1. 告警阈值设置
- **60%**: 开始关注，记录INFO日志
- **80%**: 发出警告，准备扩容方案
- **95%**: 危险状态，立即处理

### 2. 处理建议
- **正常状态**: 无需操作
- **注意状态**: 监控数据增长趋势
- **警告状态**: 准备扩容或清理方案
- **危险状态**: 立即重建或扩容

### 3. 预防措施
- 定期检查数据增长速度
- 根据业务发展调整容量配置
- 设置合理的数据保留策略
- 建立自动化运维流程

## 故障排查

### 1. 使用率异常高
**可能原因**:
- 数据增长超出预期
- 数据清理任务失效
- 配置参数不合理

**解决方案**:
- 检查数据增长趋势
- 手动执行清理任务
- 调整保留天数或容量

### 2. 监控任务失效
**可能原因**:
- 定时任务被禁用
- 系统资源不足
- 配置错误

**解决方案**:
- 检查定时任务状态
- 查看系统资源使用情况
- 验证配置参数

### 3. 告警级别不准确
**可能原因**:
- 计算逻辑错误
- 数据统计不准确
- 阈值设置不合理

**解决方案**:
- 手动验证使用率计算
- 重建布隆过滤器
- 调整告警阈值
